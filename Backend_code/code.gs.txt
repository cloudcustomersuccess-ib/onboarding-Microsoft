/**
 * ENTRYPOINTS Web App
 * Usamos "path" como router: ?path=/auth/request-otp etc.
 * Body en JSON (POST).
 */

function doGet(e) {
  return handle_(e, "GET");
}

function doPost(e) {
  return handle_(e, "POST");
}

function handle_(e, method) {
  let req;
  try {
    req = normalizeRequest_(e, method);
    return apiHandle_(req);
  } catch (err) {
    const obj = { error: String(err && (err.message || err)) };

    // NOTE: HtmlService avoids the 302 redirect from ContentService.
    if (typeof respond_ === "function" && req) {
      return respond_(req, obj, 500);
    }

    return ContentService
      .createTextOutput(JSON.stringify(obj))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function normalizeRequest_(e, method) {
  const query = (e && e.parameter) ? e.parameter : {};
  const path = query.path ? String(query.path) : "/";

  let body = {};
  if (e && e.postData && e.postData.contents) {
    try { body = JSON.parse(e.postData.contents); } catch (_) { body = {}; }
  }

  return { method, path, query, body };
}
