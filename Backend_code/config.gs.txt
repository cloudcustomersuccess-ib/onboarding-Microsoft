/**
 * CONFIGURACIÓN CENTRAL
 */

const CONFIG = {
  // 1) ID de tu Google Sheet (OBLIGATORIO)
  SPREADSHEET_ID: "1EEMYe1RLNYbCtn446z0FYNfbga6ThEnAAeKQejTLmM0",

  // 2) Nombres exactos de pestañas
  SHEETS: {
    ONBOARDINGS: "Onboardings",
    MIRROR: "Onboarding_Mirror",
    USERS: "Users",
    ORGS: "Organizations",
    USER_ONBOARDINGS: "UserOnboardings",
    NOTES: "Notes",
    AUDIT: "AuditLog",

    // ✅ NUEVO: submissions del form AWS Registration
    AWS_REGISTRATION_SUBMISSIONS: "AwsRegistrationSubmissions",
  },

PDF: {
  AWS_TEMPLATE_FILE_ID: "11ZXjwsDywUidMCGt4ghAk76epzPOroQQe06KceUN3ZU",
  // Opcional: carpeta donde guardar PDFs generados
  AWS_OUTPUT_FOLDER_ID: "1OSxvDZpU3evwubqCwHchezG4ApVHEWOb", // si lo dejas "", lo guarda en My Drive root
},

POWER_AUTOMATE: {
  // Flow con trigger: "When an HTTP request is received"
  FLOW_URL: "PEGA_AQUI_URL_DEL_TRIGGER_HTTP",
  // Secret para que el Flow valide que viene de Apps Script
  FLOW_SECRET: "PEGA_UN_SECRET_LARGO",
  AWS_PDF_FLOW_URL: "https://default7fe14ab68f5d413984bfcd8aed0ee6.b9.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ebb2a773dee64f39b1fb1b1473997d1a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=w1-ujjJ5Rfe5YPaIlkX1B8lZUfnGO7vROOquyQIHss0",
},

  // ✅ NUEVO: configuración de FORMS (endpoint público protegido por secret)
  FORMS: {
    // Secret que debe venir en req.body.secret (o query.secret) para /forms/aws-registration/save
    // Cámbialo por uno largo y aleatorio.
    AWS_REGISTRATION_SECRET: "CHANGE_ME_TO_A_LONG_RANDOM_SECRET",
  },

  // 3) OTP
  OTP: {
    LENGTH: 6,
    TTL_MINUTES: 10,
  },

  // 4) Roles
  ROLES: {
    ADMIN: "ADMIN",
    USER: "USER",
  },

  // 5) Email via Power Automate (Outlook)
  EMAIL: {
    // URL del Flow (When an HTTP request is received)
    OUTLOOK_FLOW_URL:
      "https://default7fe14ab68f5d413984bfcd8aed0ee6.b9.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/971cd2b7dc684d5faabf1a92958e2ef8/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=NLJnnpziKWq4R9U3ZMa7WSeIIc24SUUCKHqR4JxVC-o",

    // Secret opcional (recomendado) que validará el Flow
    OUTLOOK_FLOW_SECRET: "nkyXizhzqhCykbggdAkvLG8w",

    // nombre del campo que enviamos al Flow para validar
    SECRET_FIELD: "secret",
  },

  // 6) Sync endpoint secret (opcional, recomendado)
  SYNC: {
    SHAREPOINT_SECRET: "R9olA6yKzM1IZt4TraY47Gab",
  },

  // 7) Update SharePoint (Apps Script -> Flow C -> SharePoint ValidateUpdateListItem)
  UPDATE: {
    SHAREPOINT_UPDATE_FLOW_URL:
      "https://default7fe14ab68f5d413984bfcd8aed0ee6.b9.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3abbc810bbda4ce8919e0c0e044393b2/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xiVmF3GLRMa2jwzRv0wfV9HqGcxB1lbfXMLzOlXv4gs",
    SHAREPOINT_UPDATE_SECRET: "0ijLNTeLjmTc6ODjwqQyY37E",
  },
};

/**
 * Campos editables por el partner (USER), según lo acordado.
 */
const PARTNER_EDITABLE_FIELDS = new Set([
  // Paso 1
  "Alta_Hola_TDSynnex_",
  "SEPA_B2B_Completado",

  // Paso 2 Microsoft
  "Alta_PAC_MFT",
  "Alta_MF_Cloud_AI",
  "TD_handshake_MFT",

  // Paso 2 AWS
  "AWS Partner Account",
  "AWS_Partner_Engagement",
  "AWS Form",
  "AWS_DSA",
  "AWS_Marketplace",

  // Paso 2 Google
  "GC_ID",
  "Google_Cloud_Domain",

  // Paso 3
  "ION_T&C_aceptados",
  "Program_Request",
]);

/**
 * Tipado mínimo por campo para saber si aplica CompletedAt o no.
 * (Si un campo no está aquí, asumimos BOOLEAN por defecto.)
 */
const FIELD_TYPES = {
  GC_ID: "TEXT",
  Google_Cloud_Domain: "TEXT",
};

/**
 * Mapping: FieldKey (UI / Google Sheet) -> Internal Name (SharePoint)
 * Usamos los internal names reales que has pasado.
 */
const SP_INTERNAL_FIELD_MAP = {
  // Paso 1
  "Alta_Hola_TDSynnex_": "Alta_Hola_TDSynnex_",
  "SEPA_B2B_Completado": "SEPA_B2B_Completado",

  // Paso 2 Microsoft
  "Alta_PAC_MFT": "Alta_PAC_MFT",
  "Alta_MF_Cloud_AI": "Alta_MF_Cloud_AI",
  "TD_handshake_MFT": "TD_handshake_MFT",

  // Paso 2 AWS
  "AWS Partner Account": "AWSPartnerAccount",
  "AWS_Partner_Engagement": "AWS_Partner_Engagement",
  "AWS Form": "AWSForm",
  "AWS_DSA": "AWS_DSA",
  "AWS_Marketplace": "AWS_Marketplace",

  // Paso 2 Google
  "GC_ID": "GC_ID",
  "Google_Cloud_Domain": "Google_Cloud_Domain",

  // Paso 3
  "ION_T&C_aceptados": "ION_TC_aceptados",
  "Program_Request": "Program_Request",
};

/**
 * Construye el body para el Flow de Outlook, incluyendo SIEMPRE el secret.
 *
 * @param {Object} emailData - { to, subject, htmlBody, ... }
 * @returns {Object} payload listo para enviar a Power Automate
 */
function buildOutlookFlowPayload_(emailData) {
  const payload = Object.assign({}, emailData);
  payload[CONFIG.EMAIL.SECRET_FIELD] = CONFIG.EMAIL.OUTLOOK_FLOW_SECRET;
  return payload;
}